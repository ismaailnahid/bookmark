<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bookmark Editor with Favicon & Reload</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 900px;
  }
  h1 {
    margin-bottom: 10px;
  }
  #controls {
    margin-bottom: 10px;
  }
  input, button {
    margin: 5px 5px 10px 0;
    padding: 6px 10px;
    font-size: 14px;
  }
  #bookmarkContainer ul {
    list-style-type: none;
    padding-left: 20px;
  }
  #bookmarkContainer li {
    margin-bottom: 6px;
    user-select: none;
  }
  .folder {
    position: relative;
  }
  .folder-header {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .folder-toggle {
    cursor: pointer;
    font-weight: bold;
    width: 20px;
    user-select: none;
    display: inline-block;
  }
  .folder > input[type=text] {
    font-weight: bold;
    cursor: text;
    padding-left: 5px;
    position: relative;
    width: 220px;
  }
  .bookmark-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .bookmark-item img {
    width: 16px;
    height: 16px;
    margin-right: 6px;
    border-radius: 3px;
    vertical-align: middle;
  }
  .bookmark-item input[type=text] {
    padding: 4px 6px;
    font-size: 14px;
  }
  .bookmark-title {
    flex: 1 1 auto;
  }
  .bookmark-url {
    flex: 2 1 auto;
  }
  .bookmark-item .icon {
    user-select: none;
  }
  .bookmark-item button {
    padding: 3px 8px;
    font-size: 13px;
  }
  .selected-folder {
    background-color: #d0eaff;
    border-radius: 4px;
    padding: 2px 6px;
  }
  #searchInput {
    width: 400px;
  }
  @media (max-width: 600px) {
    #searchInput {
      width: 100%;
    }
    .folder > input[type=text], .bookmark-item input[type=text] {
      width: 100%;
    }
  }
</style>
</head>
<body>

<h1>Bookmark Editor with Favicon & Reload</h1>

<div id="controls">
  <input type="file" id="fileInput" accept=".html" />
  <input type="text" id="searchInput" placeholder="Search bookmarks or folders..." />
  <button id="addFolderBtn" style="display:none;">Add Folder</button>
  <button id="addBookmarkBtn" style="display:none;">Add Bookmark</button>
  <button id="exportBtn" style="display:none;">Export as HTML</button>
</div>

<div id="bookmarkContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  let bookmarkTree = null;
  let selectedFolderNode = null;
  let searchQuery = '';

  // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶° ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø WeakSet
  const expandedFolders = new WeakSet();

  // ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞
  function getDomain(url) {
    try {
      const u = new URL(url);
      return u.hostname;
    } catch {
      return null;
    }
  }

  // ‡¶ó‡ßÅ‡¶ó‡¶≤‡ßá‡¶∞ ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶¶‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® URL ‡¶®‡ßá‡ßü‡¶æ
  function getFaviconUrl(url) {
    const domain = getDomain(url);
    if(!domain) return '';
    return `https://www.google.com/s2/favicons?domain=${domain}`;
  }

  // ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const content = event.target.result;
      parseBookmarkHTML(content);
      selectedFolderNode = bookmarkTree;
      renderTree();
      document.getElementById('addFolderBtn').style.display = 'inline-block';
      document.getElementById('addBookmarkBtn').style.display = 'inline-block';
      document.getElementById('exportBtn').style.display = 'inline-block';
    };
    reader.readAsText(file);
  });

  // HTML ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡¶æ‡¶∞
  function parseBookmarkHTML(html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    function parseDL(dlElem) {
      const children = [];
      for(let i = 0; i < dlElem.children.length; i++) {
        const dt = dlElem.children[i];
        if(dt.tagName !== 'DT') continue;

        const h3 = dt.querySelector('H3');
        const dlChild = dt.querySelector('DL');
        if(h3 && dlChild) {
          children.push({
            type: 'folder',
            title: h3.textContent,
            children: parseDL(dlChild)
          });
        } else {
          const a = dt.querySelector('A');
          if(a) {
            children.push({
              type: 'bookmark',
              title: a.textContent,
              url: a.href
            });
          }
        }
      }
      return children;
    }

    const dlRoot = doc.querySelector('DL');
    bookmarkTree = {
      type: 'folder',
      title: 'Bookmarks',
      children: dlRoot ? parseDL(dlRoot) : []
    };
  }

  // ‡¶Æ‡ßÇ‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  function renderTree() {
    const container = document.getElementById('bookmarkContainer');
    container.innerHTML = '';

    if(!bookmarkTree) {
      container.textContent = 'Upload a bookmark HTML file to start.';
      return;
    }

    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
    function filterNode(node) {
      if(searchQuery === '') return node;
      if(node.type === 'bookmark') {
        return node.title.toLowerCase().includes(searchQuery) ? node : null;
      }
      if(node.type === 'folder') {
        const filteredChildren = node.children.map(filterNode).filter(c => c !== null);
        if(filteredChildren.length > 0 || node.title.toLowerCase().includes(searchQuery)) {
          return {...node, children: filteredChildren};
        }
        return null;
      }
      return null;
    }

    const filteredTree = filterNode(bookmarkTree);
    if(!filteredTree) {
      container.textContent = 'No bookmarks or folders found.';
      return;
    }

    function createList(node) {
      const ul = document.createElement('ul');
      node.children.forEach((child, index) => {
        const li = document.createElement('li');
        li.dataset.index = index;

        if(child.type === 'folder') {
          li.className = 'folder';

          const header = document.createElement('div');
          header.className = 'folder-header';

          // ‡¶ü‡¶ó‡¶≤ ‡¶Ü‡¶á‡¶ï‡¶®
          const toggleBtn = document.createElement('span');
          toggleBtn.className = 'folder-toggle';
          toggleBtn.textContent = expandedFolders.has(child) ? '‚ñº' : '‚ñ∫';
          toggleBtn.title = expandedFolders.has(child) ? 'Collapse folder' : 'Expand folder';
          toggleBtn.addEventListener('click', e => {
            e.stopPropagation();
            if(expandedFolders.has(child)) {
              expandedFolders.delete(child);
            } else {
              expandedFolders.add(child);
            }
            renderTree();
          });
          header.appendChild(toggleBtn);

          // ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
          const input = document.createElement('input');
          input.type = 'text';
          input.value = child.title;
          input.title = 'Folder name';
          input.spellcheck = false;
          input.autocomplete = 'off';

          input.addEventListener('input', e => {
            child.title = e.target.value;
          });

          input.addEventListener('click', e => e.stopPropagation());
          input.addEventListener('focus', e => {
            selectedFolderNode = child;
            highlightSelectedFolder();
          });

          header.appendChild(input);

          // ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete Folder';
          delBtn.style.marginLeft = '8px';
          delBtn.title = 'Delete this folder and all its contents';
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if(confirm(`Are you sure you want to delete the folder "${child.title}" and all its contents?`)) {
              node.children.splice(index, 1);
              if(selectedFolderNode === child) selectedFolderNode = bookmarkTree;
              renderTree();
            }
          });
          header.appendChild(delBtn);

          li.appendChild(header);

          // ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
          if(expandedFolders.has(child)) {
            li.appendChild(createList(child));
          }

        } else if(child.type === 'bookmark') {
          const div = document.createElement('div');
          div.className = 'bookmark-item';

          // ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® ‡¶á‡¶Æ‡ßá‡¶ú
          const faviconImg = document.createElement('img');
          faviconImg.src = getFaviconUrl(child.url);
          faviconImg.alt = 'Favicon';

          // ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® ‡¶¨‡¶æ‡¶ü‡¶®
          const reloadBtn = document.createElement('button');
          reloadBtn.title = 'Reload Favicon';
          reloadBtn.textContent = 'üîÑ';
          reloadBtn.style.fontSize = '16px';
          reloadBtn.style.cursor = 'pointer';
          reloadBtn.style.padding = '0 6px';
          reloadBtn.style.marginLeft = '6px';

          reloadBtn.addEventListener('click', () => {
            faviconImg.src = getFaviconUrl(child.url) + `&t=${Date.now()}`;
          });

          const iconSpan = document.createElement('span');
          iconSpan.className = 'icon';
          iconSpan.textContent = 'üîó';
          iconSpan.title = 'Bookmark';

          const titleInput = document.createElement('input');
          titleInput.type = 'text';
          titleInput.className = 'bookmark-title';
          titleInput.value = child.title;
          titleInput.placeholder = 'Title';
          titleInput.spellcheck = false;
          titleInput.autocomplete = 'off';

          titleInput.addEventListener('input', e => {
            child.title = e.target.value;
          });

          const urlInput = document.createElement('input');
          urlInput.type = 'text';
          urlInput.className = 'bookmark-url';
          urlInput.value = child.url;
          urlInput.placeholder = 'URL';
          urlInput.spellcheck = false;
          urlInput.autocomplete = 'off';

          urlInput.addEventListener('input', e => {
            child.url = e.target.value;
            // URL ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá ‡¶´‡ßá‡¶≠‡¶ø‡¶ï‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            faviconImg.src = getFaviconUrl(child.url) + `&t=${Date.now()}`;
          });

          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.title = 'Remove Bookmark';
          removeBtn.addEventListener('click', () => {
            node.children.splice(index, 1);
            renderTree();
          });

          div.appendChild(faviconImg);
          div.appendChild(iconSpan);
          div.appendChild(titleInput);
          div.appendChild(urlInput);
          div.appendChild(reloadBtn);
          div.appendChild(removeBtn);

          li.appendChild(div);
        }

        ul.appendChild(li);
      });

      Sortable.create(ul, {
        group: 'nested',
        animation: 150,
        fallbackOnBody: true,
        swapThreshold: 0.65,
        onEnd: function (evt) {
          if(!evt.from || !evt.to) return;

          function findNodeFromList(ulElement) {
            return ulElement._nodeRef;
          }

          const fromNode = findNodeFromList(evt.from);
          const toNode = findNodeFromList(evt.to);
          if(!fromNode || !toNode) return;

          const item = fromNode.children.splice(evt.oldIndex, 1)[0];
          toNode.children.splice(evt.newIndex, 0, item);

          renderTree();
        }
      });

      ul._nodeRef = node;
      return ul;
    }

    container.appendChild(createList(filteredTree));
    highlightSelectedFolder();
  }

  // ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü
  function highlightSelectedFolder() {
    document.querySelectorAll('#bookmarkContainer .folder > .folder-header > input[type=text]').forEach(input => {
      if(selectedFolderNode && input.value === selectedFolderNode.title) {
        input.classList.add('selected-folder');
        input.scrollIntoView({block: 'nearest'});
      } else {
        input.classList.remove('selected-folder');
      }
    });
  }

  // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°
  document.getElementById('addFolderBtn').addEventListener('click', () => {
    if(!selectedFolderNode) {
      alert('Please select a folder to add a new folder.');
      return;
    }
    selectedFolderNode.children.push({
      type: 'folder',
      title: 'New Folder',
      children: []
    });
    renderTree();
  });

  // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°
  document.getElementById('addBookmarkBtn').addEventListener('click', () => {
    if(!selectedFolderNode) {
      alert('Please select a folder to add a bookmark.');
      return;
    }
    selectedFolderNode.children.push({
      type: 'bookmark',
      title: '',
      url: ''
    });
    renderTree();
  });

  // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
  document.getElementById('searchInput').addEventListener('input', e => {
    searchQuery = e.target.value.trim().toLowerCase();
    renderTree();
  });
</script>

</body>
</html>
