<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bookmark Editor with Export</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 900px;
  }
  h1 {
    margin-bottom: 10px;
  }
  #controls {
    margin-bottom: 10px;
  }
  input, button {
    margin: 5px 5px 10px 0;
    padding: 6px 10px;
    font-size: 14px;
  }
  #bookmarkContainer ul {
    list-style-type: none;
    padding-left: 20px;
  }
  #bookmarkContainer li {
    margin-bottom: 6px;
    user-select: none;
  }
  .folder {
    position: relative;
  }
  .folder-header {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .folder-toggle {
    cursor: pointer;
    font-weight: bold;
    width: 20px;
    user-select: none;
    display: inline-block;
  }
  .folder > input[type=text] {
    font-weight: bold;
    cursor: text;
    padding-left: 5px;
    position: relative;
    width: 220px;
  }
  .bookmark-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .bookmark-item img {
    width: 16px;
    height: 16px;
    margin-right: 6px;
    border-radius: 3px;
    vertical-align: middle;
  }
  .bookmark-item input[type=text] {
    padding: 4px 6px;
    font-size: 14px;
  }
  .bookmark-title {
    flex: 1 1 auto;
  }
  .bookmark-url {
    flex: 2 1 auto;
  }
  .bookmark-item .icon {
    user-select: none;
  }
  .bookmark-item button {
    padding: 3px 8px;
    font-size: 13px;
  }
  .selected-folder {
    background-color: #d0eaff;
    border-radius: 4px;
    padding: 2px 6px;
  }
  #searchInput {
    width: 400px;
  }
  .input-hint {
    font-size: 12px;
    color: #555;
    margin-left: 8px;
    font-style: italic;
  }
</style>
</head>
<body>
<h1>Bookmark Editor</h1>
<div id="controls">
  <input type="file" id="fileInput" accept=".html" />
  <input type="text" id="searchInput" placeholder="Search bookmarks or folders..." />
  <button id="addFolderBtn" style="display:none;">Add Folder</button>
  <button id="addBookmarkBtn" style="display:none;">Add Bookmark</button>
  <button id="downloadBtn" style="display:none;">Download Bookmark</button>
</div>
<div id="bookmarkContainer"></div>
<script>
let bookmarkTree = null;
let selectedFolderNode = null;
let searchQuery = '';
const expandedFolders = new WeakSet();
let folderInputMap = new WeakMap();

function getDomain(url) {
  try { return new URL(url).hostname; } catch { return ''; }
}
function getFaviconUrl(url) {
  const domain = getDomain(url);
  return domain ? `https://www.google.com/s2/favicons?domain=${domain}` : '';
}
function showInputHint(msg, input) {
  const hint = document.createElement('span');
  hint.className = 'input-hint';
  hint.textContent = msg;
  input.parentNode.appendChild(hint);
  input.addEventListener('blur', () => hint.remove(), { once: true });
}
function parseBookmarkHTML(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const dlRoot = doc.querySelector('DL');
  function parseDL(dl) {
    const children = [];
    [...dl.children].forEach(dt => {
      const h3 = dt.querySelector('H3');
      const dlChild = dt.querySelector('DL');
      if (h3 && dlChild) {
        children.push({ type: 'folder', title: h3.textContent, children: parseDL(dlChild) });
      } else {
        const a = dt.querySelector('A');
        if (a) children.push({ type: 'bookmark', title: a.textContent, url: a.href });
      }
    });
    return children;
  }
  bookmarkTree = { type: 'folder', title: 'Bookmarks', children: dlRoot ? parseDL(dlRoot) : [] };
}
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    parseBookmarkHTML(e.target.result);
    selectedFolderNode = bookmarkTree;
    expandedFolders.add(bookmarkTree);
    renderTree();
    document.getElementById('addFolderBtn').style.display = 'inline-block';
    document.getElementById('addBookmarkBtn').style.display = 'inline-block';
    document.getElementById('downloadBtn').style.display = 'inline-block';
  };
  reader.readAsText(file);
});
function renderTree() {
  const container = document.getElementById('bookmarkContainer');
  container.innerHTML = '';
  if (!bookmarkTree) return container.textContent = 'Upload a bookmark HTML file to start.';
  folderInputMap = new WeakMap();
  function createList(node) {
    const ul = document.createElement('ul');
    node.children.forEach((child, i) => {
      const li = document.createElement('li');
      if (child.type === 'folder') {
        li.className = 'folder';
        const header = document.createElement('div');
        header.className = 'folder-header';

        const toggle = document.createElement('span');
        toggle.className = 'folder-toggle';
        toggle.textContent = expandedFolders.has(child) ? 'â–¼' : 'â–º';
        toggle.addEventListener('click', () => {
          expandedFolders.has(child) ? expandedFolders.delete(child) : expandedFolders.add(child);
          renderTree();
        });
        header.appendChild(toggle);

        const input = document.createElement('input');
        input.type = 'text';
        input.value = child.title;
        input.addEventListener('input', e => child.title = e.target.value);
        input.addEventListener('focus', () => {
          selectedFolderNode = child;
          highlightSelectedFolder();
        });
        header.appendChild(input);
        folderInputMap.set(child, input);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete Folder';
        delBtn.addEventListener('click', () => {
          node.children.splice(i, 1);
          if (selectedFolderNode === child) selectedFolderNode = bookmarkTree;
          renderTree();
        });
        header.appendChild(delBtn);
        li.appendChild(header);
        if (expandedFolders.has(child)) li.appendChild(createList(child));
      } else {
        const div = document.createElement('div');
        div.className = 'bookmark-item';
        const fav = document.createElement('img');
        fav.src = getFaviconUrl(child.url);
        const title = document.createElement('input');
        title.className = 'bookmark-title';
        title.value = child.title;
        title.addEventListener('input', e => child.title = e.target.value);
        const url = document.createElement('input');
        url.className = 'bookmark-url';
        url.value = child.url;
        url.addEventListener('input', e => {
          child.url = e.target.value;
          fav.src = getFaviconUrl(child.url) + '&t=' + Date.now();
        });
        const reloadBtn = document.createElement('button');
        reloadBtn.textContent = 'ðŸ”„';
        reloadBtn.addEventListener('click', () => {
          fav.src = getFaviconUrl(child.url) + '&t=' + Date.now();
        });
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
          node.children.splice(i, 1);
          renderTree();
        });
        div.append(fav, title, url, reloadBtn, removeBtn);
        li.appendChild(div);
      }
      ul.appendChild(li);
    });
    return ul;
  }
  container.appendChild(createList(bookmarkTree));
  highlightSelectedFolder();
}
function highlightSelectedFolder() {
  document.querySelectorAll('.folder-header input').forEach(input => {
    input.classList.toggle('selected-folder', selectedFolderNode && input.value === selectedFolderNode.title);
  });
}
function focusLastInputInSelectedFolder(type) {
  const container = document.getElementById('bookmarkContainer');
  if (!selectedFolderNode) return;
  const folders = [...container.querySelectorAll('li.folder')];
  for (const folder of folders) {
    const input = folder.querySelector('input[type="text"]');
    if (input && input.value === selectedFolderNode.title) {
      const inputs = type === 'folder'
        ? folder.querySelectorAll('.folder-header input[type="text"]')
        : folder.querySelectorAll('.bookmark-item input.bookmark-title');
      if (inputs.length) {
        const lastInput = inputs[inputs.length - 1];
        lastInput.focus();
        showInputHint(`Added ${type} inside: "${selectedFolderNode.title}"`, lastInput);
      }
      break;
    }
  }
}
document.getElementById('addFolderBtn').addEventListener('click', () => {
  if (!selectedFolderNode) return alert('Select a folder.');
  selectedFolderNode.children.push({ type: 'folder', title: 'New Folder', children: [] });
  expandedFolders.add(selectedFolderNode);
  renderTree();
  requestAnimationFrame(() => focusLastInputInSelectedFolder('folder'));
});
document.getElementById('addBookmarkBtn').addEventListener('click', () => {
  if (!selectedFolderNode) return alert('Select a folder.');
  selectedFolderNode.children.push({ type: 'bookmark', title: '', url: '' });
  expandedFolders.add(selectedFolderNode);
  renderTree();
  requestAnimationFrame(() => focusLastInputInSelectedFolder('bookmark'));
});
document.getElementById('searchInput').addEventListener('input', e => {
  searchQuery = e.target.value.trim().toLowerCase();
  renderTree();
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  if (!bookmarkTree) return alert('No bookmarks to export!');
  const htmlContent = convertToBookmarkHTML(bookmarkTree);
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'bookmarks.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

function convertToBookmarkHTML(node) {
  function escapeHTML(str) {
    return str.replace(/[&<>'"]/g, tag => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '\'': '&#39;', '"': '&quot;'
    }[tag]));
  }

  function buildDL(node) {
    let html = '<DL><p>';
    for (const child of node.children) {
      if (child.type === 'folder') {
        html += `<DT><H3>${escapeHTML(child.title)}</H3>\n`;
        html += buildDL(child);
        html += '</DL><p>\n';
      } else if (child.type === 'bookmark') {
        const iconUrl = getFaviconUrl(child.url);
        html += `<DT><A HREF="${escapeHTML(child.url)}" ICON="${iconUrl}">${escapeHTML(child.title)}</A>\n`;
      }
    }
    html += '</DL><p>\n';
    return html;
  }

  return `
<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file. -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
${buildDL(node)}
`.trim();
}
</script>
</body>
</html>
